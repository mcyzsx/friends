name: Add Link from Issue

on:
  issues:
    types: [closed]

jobs:
  add-link:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, '已通过')
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install deps
        run: npm i js-yaml axios

      - name: Parse and append
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const body = context.payload.issue.body;
            const m = body.match(/```json\s*([\s\S]*?)\s*```/);
            if (!m) throw '未找到 JSON 块';
            let entry;
            try { entry = JSON.parse(m[1]); } catch { throw 'JSON 格式错误'; }

            const list = JSON.parse(fs.readFileSync('data.json','utf8')||'[]');
            list.push(entry);
            fs.writeFileSync('data.json', JSON.stringify(list,null,2));

      - name: Commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data.json
          git commit -m "Add link from #${{ github.event.issue.number }}"
          git push
