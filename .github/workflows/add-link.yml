name: Add Link from Issue

on:
  issues:
    types: [closed]

jobs:
  add-link:
    runs-on: ubuntu-latest
    # ① 标签已通过 ② 关闭者是仓库所有者
    if: |
      contains(github.event.issue.labels.*.name, '已通过') &&
      github.actor == github.repository_owner
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Parse & append
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const body = context.payload.issue.body;

            /* === 提取 JSON（兼容有无围栏）=== */
            const m = body.match(/(?:```json\s*([\s\S]*?)\s*```)|(\{[\s\S]*?\})/);
            if (!m) throw '❌ 未找到 JSON 块';
            let raw;
            try { raw = JSON.parse(m[1] || m[0]); } catch { throw '❌ JSON 格式错误'; }

            /* === 字段映射 === */
            const entry = {
              author:  raw.author  || '',
              sitenick:raw.sitenick|| '',
              link:    raw.link    || '',
              avatar:  raw.avatar  || '',
              desc:    raw.desc    || '',
              date: new Date().toISOString().slice(0,10)
            };

            /* === 追加到 data.json === */
            const list = JSON.parse(fs.readFileSync('data.json','utf8')||'[]');
            list.push(entry);
            fs.writeFileSync('data.json', JSON.stringify(list,null,2));

      - name: Commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data.json
          git commit -m "Add link from #${{ github.event.issue.number }}"
          git push
