name: Add Link from Issue

on:
  issues:
    types: [closed]

jobs:
  add-link:
    runs-on: ubuntu-latest
    if: |
      contains(github.event.issue.labels.*.name, '已通过') &&
      github.actor == github.repository_owner
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Parse & upsert
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const body = context.payload.issue.body;

            /* 1. 提取 JSON */
            const m = body.match(/(?:```json\s*([\s\S]*?)\s*```)|(\{[\s\S]*?\})/);
            if (!m) throw '❌ 未找到 JSON 块';
            let raw;
            try { raw = JSON.parse(m[1] || m[0]); } catch { throw '❌ JSON 格式错误'; }

            /* 2. 构造目标对象 */
            const now = new Date().toISOString().slice(0,10);
            const incoming = {
              author:  raw.author  || '',
              sitenick:raw.sitenick|| '',
              link:    raw.link    || '',
              avatar:  raw.avatar  || '',
              desc:    raw.desc    || '',
              date:    raw.date    || now          // 保留旧日期或新增
            };

            /* 3. 读库 */
            const list = JSON.parse(fs.readFileSync('data.json','utf8')||'[]');

            /* 4. 按 link 当唯一键：找同链接就更新，否则追加 */
            const idx = list.findIndex(e => e.link === incoming.link);
            if (idx === -1) list.push(incoming);
            else list[idx] = incoming;            // 原地更新

            /* 5. 写回 */
            fs.writeFileSync('data.json', JSON.stringify(list,null,2));

      - name: Commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data.json
          git commit -m "Upsert link from #${{ github.event.issue.number }}"
          git push
